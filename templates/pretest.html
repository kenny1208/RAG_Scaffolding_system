{% extends "base.html" %} 

{% block content %}
<div id="vanta-bg" style="position: fixed; width: 100%; height: 100%; z-index: -1; top: 0; left: 0;"></div>

<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card">
      <div class="card-body">
        <h2 class="card-title text-center mb-4">{{ pretest.title }}</h2>
        <p class="lead text-center mb-4">{{ pretest.description }}</p>

        <!-- ✅ 倒數計時器 -->
        <div id="timer-box-pretest">
          <span id="countdown-pretest">02:00</span>
        </div>

        <form id="pretest-form">
          {% for question in pretest.questions %} {% set question_index =
          loop.index0 %}
          <div class="mb-4">
            <h3 class="h5 mb-3">{{ loop.index }}. {{ question.question }}</h3>

            <div class="radio-input">
              {% for choice in question.choices %}
              <label class="label">
                <input
                  type="radio"
                  name="question_{{ question_index }}"
                  value="{{ choice[0] }}"
                  required
                />
                <p class="text">{{ choice }}</p>
              </label>
              {% endfor %}
            </div>


          </div>
          {% endfor %}

          <div class="d-grid">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check me-2"></i>
              Submit Test
            </button>
          </div>
        </form>

        <!-- Results Modal -->
        <div
          class="modal fade"
          id="resultsModal"
          tabindex="-1"
          aria-labelledby="resultsModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="resultsModalLabel" style="font-weight: bold;">測驗結果</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <div id="results-content"></div>
                <div class="text-center mt-4">
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="continue-btn"
                  >
                    繼續學習
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .card {
    background-color: transparent !important; /* 移除白底 */
    border: none !important;
    border-radius: 20px;
    overflow: hidden;
  }

  .card-body {  
    background-color: #00000079 !important; /* 黑色卡片內容 */
    color: #fff !important;           /* 白色文字 */
    background: none; /* 移除內層背景 */
  }

  .modal-content {
  background-color: #000000b6 !important; /* 深藍色 */
  color: #fff !important; /* 文字白色 */
  }

  /* 如果要保證裡面所有字都變白 */
  .modal-content * {
    color: #fff !important;
  }

  .alert-info {
  background-color: #000040c0 !important; /* 深藍色 */
  color: #fff !important; /* 白色文字 */
  border: none; /* 移除邊框 */
  border-radius: 10px; /* 圓角 */
  }

  .alert-info .alert-heading {
    color: #fff !important;
  }

  .result-card {
  background-color: #01013cb0 !important; 
  color: #fff !important; /* 白色文字 */
}

/* 如果想讓卡片內的文字也全部變白 */
.result-card .card-body * {
  color: #fff !important;
}

  .card-body h2,
  .card-body h3,
  .card-body label,
  .card-body .list-group-item,
  .card-body .btn {
    color: #fff !important;
  }

  .list-group-item {
    background-color: transparent;
    border: 1px solid #fff;
  }

  .form-check-input {
    accent-color: #0d6efd; /* 藍色 radio 勾選 */
  }

  #timer-box-pretest {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: rgba(0,0,0,0.7);
  color: white;
  padding: 15px 20px;
  border-radius: 8px;
  font-size: 25px;
  font-weight: bold;
  z-index: 9999;
  box-shadow: 0 0 8px rgba(255,255,255,0.3);
}

#countdown-pretest {
  font-family: 'Courier New', monospace;
}

#countdown-pretest.timeout {
  color: #00ff00;
  text-shadow: 0 0 8px #00ff00;
}

.radio-input {
  display: flex;
  flex-direction: column;
  gap: 12px; /* 選項間距 */
}

.radio-input * {
  box-sizing: border-box;
  padding: 0;
  margin: 0;
}

.radio-input label {
  display: flex;
  align-items: center; /* ✅ 垂直置中 */
  gap: 15px;
  padding: 12px 20px;
  width: 100%;
  max-width: 100%;
  cursor: pointer;
  min-height: 60px;
  position: relative;
  border-radius: 10px;
  word-break: break-word;
  line-height: 1.5;
  z-index: 1;
}

.radio-input label::before {
  position: absolute;
  content: "";
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: calc(100% - 10px);
  height: calc(100% - 8px);
  z-index: -1;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  border-radius: 10px;
  border: 2px solid transparent;
}

.radio-input label:hover::before {
  transition: all 0.2s ease;
  background-color: #00a2ff68;
}

.radio-input .label:has(input:checked)::before {
  background-color: #00a2ff68;
  border-color:  #0089d86f;
}

.radio-input .label .text {
  color: #fff;
  font-size: 1.1rem;
  flex: 1; /* ✅ 讓文字佔滿剩餘空間，便於對齊 */
}

.radio-input .label input[type="radio"] {
  background-color: #202030;
  appearance: none;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  flex-shrink: 0; /* ✅ 不讓圓圈縮小 */
  display: flex;
  justify-content: center;
  align-items: center;
}

.radio-input .label input[type="radio"]:checked {
  background-color: #435dd8;
  animation: pulse 0.7s forwards;
}

.radio-input .label input[type="radio"]::before {
  content: "";
  width: 8px;
  height: 8px;
  border-radius: 50%;
  transition: all 0.1s cubic-bezier(0.165, 0.84, 0.44, 1);
  background-color: #fff;
  transform: scale(0);
}

.radio-input .label input[type="radio"]:checked::before {
  transform: scale(1);
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
  }
}

</style>

{% endblock %} 

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("pretest-form");
    const resultsModal = new bootstrap.Modal(
      document.getElementById("resultsModal")
    );
    const resultsContent = document.getElementById("results-content");
    const continueBtn = document.getElementById("continue-btn");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const answers = [];
      // Get question count from the DOM
      const questionElements = document.querySelectorAll(".mb-4 > h3.h5");
      const questionCount = questionElements.length;

      // Check each question for an answer
      for (let i = 0; i < questionCount; i++) {
        const questionName = `question_${i}`;
        const selected = document.querySelector(
          `input[name="${questionName}"]:checked`
        );

        if (!selected) {
          alert(`Please answer question ${i + 1}`);
          return;
        }

        answers.push(selected.value);
      }

      try {
        const response = await fetch("{{ url_for('pretest') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            answers: answers,
          }),
        });

        if (response.ok) {
          const data = await response.json();

          // Display results
          let resultsHtml = "";
          data.results.forEach((result, index) => {
            const isCorrect = result.is_correct;
            const icon = isCorrect ? "✅" : "❌";
            const bgClass = isCorrect
              ? "bg-success-subtle"
              : "bg-danger-subtle";

            resultsHtml += `
              <div class="card mb-3 result-card ${bgClass}">
                <div class="card-body">
                  <h5 class="card-title">第 ${index + 1} 題 ${icon}</h5>
                  <p class="card-text">${result.question}</p>
                  <p class="card-text">
                    <strong>你的答案：</strong> ${result.student_answer}<br>
                    <strong>正確答案：</strong> ${result.correct_answer}<br>
                    <strong>解釋：</strong> ${result.explanation}
                  </p>
                </div>
              </div>
            `;
          });

          // Add score summary
          resultsHtml = `
            <div class="alert alert-info mb-4">
              <h4 class="alert-heading">測驗總結</h4>
              <p>得分：${data.score}/${data.total} (${data.percentage}%)</p>
              <p>知識水平：${data.knowledge_level}</p>
            </div>
            ${resultsHtml}
          `;

          resultsContent.innerHTML = resultsHtml;
          resultsModal.show();

          // Handle continue button click
          continueBtn.onclick = function () {
            if (data.redirect) {
              window.location.href = data.redirect;
            } else {
              window.location.href = "{{ url_for('learning') }}";
            }
          };
        } else {
          const data = await response.json();
          alert(data.error || "An error occurred");
        }
      } catch (error) {
        console.error("Error:", error);
        alert("An error occurred while submitting the test");
      }
    });
  });
</script>

<script>
  // ✅ 設定計時秒數（例：120 秒 = 2 分鐘）
let durationPretest = 1;
const countdownPretest = document.getElementById("countdown-pretest");
const submitBtnPretest = document.querySelector(".d-grid button");

// 預設按鈕禁用
submitBtnPretest.disabled = true;

function updateTimerPretest() {
  const minutes = Math.floor(durationPretest / 60);
  const seconds = durationPretest % 60;

  countdownPretest.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

  if (durationPretest <= 0) {
    clearInterval(timerPretest);
    countdownPretest.textContent = '00:00';
    countdownPretest.classList.add('timeout');

    // ✅ 啟用提交按鈕
    submitBtnPretest.disabled = false;
  } else {
    durationPretest--;
  }
}

updateTimerPretest();
const timerPretest = setInterval(updateTimerPretest, 1000);

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/tengbao/vanta@latest/dist/vanta.clouds.min.js"></script>
  <script>
    VANTA.CLOUDS({
      el: "#vanta-bg",
      mouseControls: true,
      touchControls: true,
      gyroControls: false,
      minHeight: 200.00,
      minWidth: 200.00,
      backgroundColor: 0xffffff,
      skyColor: 0x0babea,
      cloudColor: 0xadc1de,
      cloudShadowColor: 0x486a95,
      sunColor: 0xf189ff,
      sunGlareColor: 0xe36262,
      sunlightColor: 0xff7c00,
      speed: 1.0
    });
  </script>

{% endblock %}
<!-- 註解-->
