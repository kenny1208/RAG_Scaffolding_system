{% extends "base.html" %} 

{% block content %}
<div id="vanta-bg" style="position: fixed; width: 100%; height: 100%; z-index: -1; top: 0; left: 0;"></div>

<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card">
      <div class="card-body">
        <h2 class="card-title text-center mb-4">{{ pretest.title }}</h2>
        <p class="lead text-center mb-4">{{ pretest.description }}</p>

        <!-- ✅ 倒數計時器 -->
        <div id="timer-box">
          <span id="countdown-pretest">02:00</span>
        </div>
        <!-- ✅ 倒數計時器 -->
        <!-- 提示訊息卡片 -->
        <div class="card1 hidden" id="timeout-message">
          <div class="icon-container">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M13 7.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm-3 3.75a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 .75.75v4.25h.75a.75.75 0 0 1 0 1.5h-3a.75.75 0 0 1 0-1.5h.75V12h-.75a.75.75 0 0 1-.75-.75Z"/>
              <path d="M12 1c6.075 0 11 4.925 11 11s-4.925 11-11 11S1 18.075 1 12 5.925 1 12 1ZM2.5 12a9.5 9.5 0 0 0 9.5 9.5 9.5 9.5 0 0 0 9.5-9.5A9.5 9.5 0 0 0 12 2.5 9.5 9.5 0 0 0 2.5 12Z"/>
            </svg>
          </div>
          <div class="message-text-container">
            <p class="message-text">測驗時間結束</p>
            <p class="sub-text">你現在可以提交測驗</p>
          </div>
        </div>

        <form id="pretest-form">
          {% for question in pretest.questions %} {% set question_index =
          loop.index0 %}
          <div class="mb-4">
            <h3 class="h5 mb-3">{{ loop.index }}. {{ question.question }}</h3>

            <div class="radio-input">
              {% for choice in question.choices %}
              <label class="label">
                <input
                  type="radio"
                  name="question_{{ question_index }}"
                  value="{{ choice[0] }}"
                  required
                />
                <p class="text">{{ choice }}</p>
              </label>
              {% endfor %}
            </div>


          </div>
          {% endfor %}

          <div class="d-grid">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check me-2"></i>
              Submit Test
            </button>
          </div>
        </form>

        <!-- Results Modal -->
        <div
          class="modal fade"
          id="resultsModal"
          tabindex="-1"
          aria-labelledby="resultsModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="resultsModalLabel" style="font-weight: bold;">測驗結果</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <div id="results-content"></div>
                <div class="text-center mt-4">
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="continue-btn"
                  >
                    繼續學習
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Loading Overlay -->
<div id="loading-overlay" style="display:none;">
  <ul>
    <li>
      <div class="loader">
        <div class="child"></div>
      </div>
    </li>
    <li>
      <div class="text1"></div>
    </li>
  </ul>
</div>


<style>
/* 倒數計時器 */
#timer-box {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: rgba(0,0,0,0.7);
  color: white;
  padding: 15px 20px;
  border-radius: 8px;
  font-size: 25px;
  font-weight: bold;
  z-index: 9999;
  box-shadow: 0 0 8px rgba(255,255,255,0.3);
}
#countdown-pretest.timeout {
  color: #00ff00;
  text-shadow: 0 0 8px #00ff00;
}

/* 提示訊息卡片 */
#timeout-message {
  position: fixed;
  top: 100px;
  right: 1%;
  z-index: 9999;
  transform: translateX(0);
}
.hidden { display: none !important; }
.fade-up-right { animation: fadeUpRight 0.8s ease forwards; }
@keyframes fadeUpRight {
  from { opacity: 0; transform: translateY(30px) translateX(30px); }
  to { opacity: 1; transform: translateY(0) translateX(0); }
}
.card1 {
  display: flex;
  align-items: center;
  gap: 16px;
  background-color: #ffffff;
  border-radius: 10px;
  padding: 16px 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  width: auto;
  max-width: 340px;
  font-family: 'Segoe UI', sans-serif;
}
.icon-container {
  width: 40px; height: 40px; background-color: #e0edff; border-radius: 50%;
  display: flex; justify-content: center; align-items: center;
}
.icon { width: 20px; height: 20px; color: #124fff; }
.message-text { margin: 0; font-size: 16px; font-weight: bold; color: #124fff; }
.sub-text { margin: 0; font-size: 14px; color: #555555; }


  .card {
    background-color: transparent !important; /* 移除白底 */
    border: none !important;
    border-radius: 20px;
    overflow: hidden;
  }

  .card-body {  
    background-color: #00000079 !important; /* 黑色卡片內容 */
    color: #fff !important;           /* 白色文字 */
    background: none; /* 移除內層背景 */
  }

  .modal-content {
  background-color: #000000b6 !important; /* 深藍色 */
  color: #fff !important; /* 文字白色 */
  }

  /* 如果要保證裡面所有字都變白 */
  .modal-content * {
    color: #fff !important;
  }

  .alert-info {
  background-color: #000040c0 !important; /* 深藍色 */
  color: #fff !important; /* 白色文字 */
  border: none; /* 移除邊框 */
  border-radius: 10px; /* 圓角 */
  }

  .alert-info .alert-heading {
    color: #fff !important;
  }

  .result-card {
  background-color: #01013cb0 !important; 
  color: #fff !important; /* 白色文字 */
}

/* 如果想讓卡片內的文字也全部變白 */
.result-card .card-body * {
  color: #fff !important;
}

  .card-body h2,
  .card-body h3,
  .card-body label,
  .card-body .list-group-item,
  .card-body .btn {
    color: #fff !important;
  }

  .list-group-item {
    background-color: transparent;
    border: 1px solid #fff;
  }

  .form-check-input {
    accent-color: #0d6efd; /* 藍色 radio 勾選 */
  }

  #timer-box-pretest {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: rgba(0,0,0,0.7);
  color: white;
  padding: 15px 20px;
  border-radius: 8px;
  font-size: 25px;
  font-weight: bold;
  z-index: 9999;
  box-shadow: 0 0 8px rgba(255,255,255,0.3);
}

#countdown-pretest {
  font-family: 'Courier New', monospace;
}

#countdown-pretest.timeout {
  color: #00ff00;
  text-shadow: 0 0 8px #00ff00;
}

.radio-input {
  display: flex;
  flex-direction: column;
  gap: 12px; /* 選項間距 */
}

.radio-input * {
  box-sizing: border-box;
  padding: 0;
  margin: 0;
}

.radio-input label {
  display: flex;
  align-items: center; /* ✅ 垂直置中 */
  gap: 15px;
  padding: 12px 20px;
  width: 100%;
  max-width: 100%;
  cursor: pointer;
  min-height: 60px;
  position: relative;
  border-radius: 10px;
  word-break: break-word;
  line-height: 1.5;
  z-index: 1;
}

.radio-input label::before {
  position: absolute;
  content: "";
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: calc(100% - 10px);
  height: calc(100% - 8px);
  z-index: -1;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  border-radius: 10px;
  border: 2px solid transparent;
}

.radio-input label:hover::before {
  transition: all 0.2s ease;
  background-color: #00a2ff68;
}

.radio-input .label:has(input:checked)::before {
  background-color: #00a2ff68;
  border-color:  #0089d86f;
}

.radio-input .label .text {
  color: #fff;
  font-size: 1.1rem;
  flex: 1; /* ✅ 讓文字佔滿剩餘空間，便於對齊 */
}

.radio-input .label input[type="radio"] {
  background-color: #202030;
  appearance: none;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  flex-shrink: 0; /* ✅ 不讓圓圈縮小 */
  display: flex;
  justify-content: center;
  align-items: center;
}

.radio-input .label input[type="radio"]:checked {
  background-color: #435dd8;
  animation: pulse 0.7s forwards;
}

.radio-input .label input[type="radio"]::before {
  content: "";
  width: 8px;
  height: 8px;
  border-radius: 50%;
  transition: all 0.1s cubic-bezier(0.165, 0.84, 0.44, 1);
  background-color: #fff;
  transform: scale(0);
}

.radio-input .label input[type="radio"]:checked::before {
  transform: scale(1);
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
  }
}

/* Loading Overlay */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* Loader bar */
.loader {
  width: 250px;        /* was 100px */
  height: 12px;        /* was 3px */
  background-color: rgb(15, 15, 15);
  border-radius: 20px;
  overflow: hidden;
}

.child {
  width: 120px;        /* was 60px */
  height: 12px;        /* was 3px */
  background-color: rgb(107, 27, 255);
  border-radius: 20px;
  margin-left: -120px;
  animation: go 1s 0s infinite;
}

@keyframes go {
  from {
    margin-left: -100px;
    width: 80px;
  }
  to {
    width: 30px;
    margin-left: 110px;
  }
}

/* Text animation */
.text1 {
    width: 250px;        /* match loader width */
  height: 40px;
  margin-top: 25px;
  text-align: center;
  font-size: 1.5rem;   /* bigger font */
  font-weight: bold;
}

.text1::before {
  content: "Loading";
  color: white;
  animation: text 1s 0s infinite;
}

@keyframes text {
  0% { content: "批改中"; }
  30% { content: "批改中."; }
  60% { content: "批改中.."; }
  100% { content: "批改中..."; }
}


</style>

{% endblock %} 

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("pretest-form");
    const resultsModal = new bootstrap.Modal(
      document.getElementById("resultsModal")
    );
    const resultsContent = document.getElementById("results-content");
    const continueBtn = document.getElementById("continue-btn");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const answers = [];
      // Get question count from the DOM
      const questionElements = document.querySelectorAll(".mb-4 > h3.h5");
      const questionCount = questionElements.length;

      // Check each question for an answer
      for (let i = 0; i < questionCount; i++) {
        const questionName = `question_${i}`;
        const selected = document.querySelector(
          `input[name="${questionName}"]:checked`
        );

        if (!selected) {
          alert(`Please answer question ${i + 1}`);
          return;
        }

        answers.push(selected.value);
      }

      try {
        const response = await fetch("{{ url_for('pretest') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            answers: answers,
          }),
        });

        loadingOverlay.style.display = "none";

        if (response.ok) {
          const data = await response.json();

          // Display results
          let resultsHtml = "";
          data.results.forEach((result, index) => {
            const isCorrect = result.is_correct;
            const icon = isCorrect ? "✅" : "❌";
            const bgClass = isCorrect
              ? "bg-success-subtle"
              : "bg-danger-subtle";

            resultsHtml += `
              <div class="card mb-3 result-card ${bgClass}">
                <div class="card-body">
                  <h5 class="card-title">第 ${index + 1} 題 ${icon}</h5>
                  <p class="card-text">${result.question}</p>
                  <p class="card-text">
                    <strong>你的答案：</strong> ${result.student_answer}<br>
                    <strong>正確答案：</strong> ${result.correct_answer}<br>
                    <strong>解釋：</strong> ${result.explanation}
                  </p>
                </div>
              </div>
            `;
          });

          // Add score summary
          resultsHtml = `
            <div class="alert alert-info mb-4">
              <h4 class="alert-heading">測驗總結</h4>
              <p>得分：${data.score}/${data.total} (${data.percentage}%)</p>
              <p>知識水平：${data.knowledge_level}</p>
            </div>
            ${resultsHtml}
          `;

          resultsContent.innerHTML = resultsHtml;
          resultsModal.show();

          // Handle continue button click
          continueBtn.onclick = function () {
            if (data.redirect) {
              window.location.href = data.redirect;
            } else {
              window.location.href = "{{ url_for('learning') }}";
            }
          };
        } else {
          const data = await response.json();
          alert(data.error || "An error occurred");
        }
      } catch (error) {
        console.error("Error:", error);
        alert("An error occurred while submitting the test");
      }
    });
  });
</script>

<script>
let durationPretest = 1; // 測試用：10 秒
const countdownPretest = document.getElementById("countdown-pretest");
const messageBox = document.getElementById("timeout-message");
const submitBtn = document.getElementById("submit-btn-pretest");

function updateTimerPretest() {
  const min = Math.floor(durationPretest / 60);
  const sec = durationPretest % 60;
  countdownPretest.textContent = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
  
  if (durationPretest <= 0) {
    clearInterval(timerPretest);
    countdownPretest.textContent = "00:00";
    countdownPretest.classList.add("timeout");

    // 顯示訊息卡片
    messageBox.classList.remove("hidden");
    messageBox.classList.add("fade-up-right");

    // 啟用提交按鈕
    submitBtn.disabled = false;
  } else {
    durationPretest--;
  }
}
updateTimerPretest();
const timerPretest = setInterval(updateTimerPretest, 1000);


</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/tengbao/vanta@latest/dist/vanta.clouds.min.js"></script>
  <script>
    VANTA.CLOUDS({
      el: "#vanta-bg",
      mouseControls: true,
      touchControls: true,
      gyroControls: false,
      minHeight: 200.00,
      minWidth: 200.00,
      backgroundColor: 0xffffff,
      skyColor: 0x0babea,
      cloudColor: 0xadc1de,
      cloudShadowColor: 0x486a95,
      sunColor: 0xf189ff,
      sunGlareColor: 0xe36262,
      sunlightColor: 0xff7c00,
      speed: 1.0
    });
  </script>

<script>
  const pretestForm = document.getElementById("pretest-form");
  const loadingOverlay = document.getElementById("loading-overlay");

  pretestForm.addEventListener("submit", function () {
    // 顯示 loading
    loadingOverlay.style.display = "flex";
  });
</script>



{% endblock %}
<!-- 註解-->
