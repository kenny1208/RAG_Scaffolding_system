{% extends "base.html" %} {% block content %}

<div id="vanta-bg" style="position: fixed; width: 100%; height: 100%; z-index: -1; top: 0; left: 0;"></div>

<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title text-center mb-4">學習路徑討論</h2>
        <p class="lead text-center mb-4">
          讓我們一起討論並確認您的個人化學習路徑
        </p>

        <!-- Learning Path Overview -->
        <div id="learning-path-container" class="learning-path-overview mb-4">
          <h3 class="h5 mb-3">建議的學習路徑</h3>
          <div class="card">
            <div class="card-body">
              <h4 class="h6">{{ learning_path.title }}</h4>
              <p>{{ learning_path.description }}</p>

              <h5 class="mt-3">學習目標：</h5>
              <ul>
                {% for objective in learning_path.objectives %}
                <li>{{ objective }}</li>
                {% endfor %}
              </ul>

              <h5 class="mt-3">學習章節：</h5>
              <div class="list-group">
                {% for module in learning_path.modules %}
                <div class="list-group-item">
                  <h6 class="mb-1">{{ module.title }}</h6>
                  <p class="mb-1">{{ module.description }}</p>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Discussion Section -->
        <div class="discussion-section">
          <h3 class="h5 mb-3">與 AI 學習顧問討論</h3>
          <div class="chat-container">
            <div
              id="chat-messages"
              class="mb-3"
              style="height: 300px; overflow-y: auto"
            >
              <div class="message bot-message">
                您好！我是您的學習顧問。我已經根據您的學習風格和知識水平設計了這個學習路徑。
                您對這個學習路徑有什麼想法或問題嗎？我們可以一起討論並根據您的需求進行調整。
              </div>
            </div>

            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="message-input"
                placeholder="請輸入您的問題或想法..."
              />
              <button class="btn btn-primary" id="send-message">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Confirmation Button -->
        <div class="text-center mt-4">
          <button class="btn btn-success" id="confirm-path">
            <i class="fas fa-check me-2"></i>
            確認並開始學習
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Loading Overlay -->
<div id="loading-overlay" style="display:none;">
  <ul>
    <li>
      <div class="loader">
        <div class="child"></div>
      </div>
    </li>
    <li>
      <div class="text1"></div>
    </li>
  </ul>
</div>


<style>

/* Loading Overlay */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* Loader bar */
.loader {
  width: 250px;        /* was 100px */
  height: 12px;        /* was 3px */
  background-color: rgb(15, 15, 15);
  border-radius: 20px;
  overflow: hidden;
}

.child {
  width: 120px;        /* was 60px */
  height: 12px;        /* was 3px */
  background-color: rgb(107, 27, 255);
  border-radius: 20px;
  margin-left: -120px;
  animation: go 3s 0s infinite;
}

@keyframes go {
  from {
    margin-left: -100px;
    width: 80px;
  }
  to {
    width: 30px;
    margin-left: 110px;
  }
}

/* Text animation */
.text1 {
  width: 250px;        /* match loader width */
  height: 40px;
  margin-top: 25px;
  text-align: center;
  font-size: 1.5rem;   /* bigger font */
  font-weight: bold;
}

.text1::before {
  content: "Loading";
  color: white;
  animation: text 1s 0s infinite;
}

@keyframes text {
  0% { content: "生成學習教材中"; }
  30% { content: "生成學習教材中."; }
  60% { content: "生成學習教材中.."; }
  100% { content: "生成學習教材中..."; }
}


.card{
  background-color: #0000007d !important; /* 黑色背景 */
  color: #fff !important; /* 白色文字 */
  border-radius: 20px;
}

/* 確保內部所有文字都是白色 */
.card * {
  color: #fff !important;
}

/* 調整聊天訊息的背景也變黑 */
.bot-message {
  background-color: #0099ff !important; /* 比純黑稍微亮一點，區分內容 */
  color: #fff !important;
}

.user-message {
  background-color: #6a00ff !important;
  color: #fff !important;
}

/* 列表與模組項目也改為黑底白字 */
.list-group-item {
  background-color: #006eff00 !important;
  color: #fff !important;
  border: 1px solid #444; /* 稍微加個灰色邊界 */
}

.input-group {
  color: #00000082;
}

/* 輸入框黑底白字 */
.form-control {
  background-color: #0000006a !important; /* 黑色背景 */
  color: #fff !important;            /* 白色文字 */
  border: 1px solid #444;             /* 深灰邊框 */
}

/* 改變輸入框 placeholder 顏色 */
.form-control::placeholder {
  color: #aaa; /* 淺灰色 placeholder */
}

/* 輸入框在 focus 狀態下的效果 */
.form-control:focus {
  background-color: #0000007a !important; /* 保持黑底 */
  color: #fff !important;
  border-color: #666;                /* 聚焦時邊框顏色 */
  box-shadow: none;                  /* 移除 Bootstrap 藍色外框 */
}

</style>

{% endblock %} 

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const messageInput = document.getElementById("message-input");
    const sendMessageBtn = document.getElementById("send-message");
    const chatMessages = document.getElementById("chat-messages");
    const confirmPathBtn = document.getElementById("confirm-path");
    const learningPathContainer = document.getElementById(
      "learning-path-container"
    );

    // Function to update learning path section
    function updateLearningPath() {
      fetch("/api/get-current-learning-path")
        .then((response) => response.json())
        .then((data) => {
          if (data.learning_path) {
            const learningPath = data.learning_path;
            let html = `
              <h3 class="h5 mb-3">建議的學習路徑</h3>
              <div class="card">
                <div class="card-body">
                  <h4 class="h6">${learningPath.title}</h4>
                  <p>${learningPath.description}</p>

                  <h5 class="mt-3">學習目標：</h5>
                  <ul>
                    ${learningPath.objectives
                      .map((obj) => `<li>${obj}</li>`)
                      .join("")}
                  </ul>

                  <h5 class="mt-3">學習章節：</h5>
                  <div class="list-group">
                    ${learningPath.modules
                      .map(
                        (module) => `
                      <div class="list-group-item">
                        <h6 class="mb-1">${module.title}</h6>
                        <p class="mb-1">${module.description}</p>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                </div>
              </div>
            `;
            learningPathContainer.innerHTML = html;
          }
        })
        .catch((error) => {
          console.error("Error updating learning path:", error);
        });
    }

    // Handle sending messages
    function sendMessage() {
  const message = messageInput.value.trim();
  if (message) {
    const userMessage = document.createElement("div");
    userMessage.className = "message user-message";
    userMessage.textContent = message;
    chatMessages.appendChild(userMessage);
    messageInput.value = "";
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // 顯示 loading
    loadingOverlay.style.display = "flex";

    fetch("/api/discuss-learning-path", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: message }),
    })
      .then((response) => response.json())
      .then((data) => {
        loadingOverlay.style.display = "none"; // 拿到回覆 → 隱藏
        if (data.response) {
          const botMessage = document.createElement("div");
          botMessage.className = "message bot-message";
          botMessage.textContent = data.response;
          chatMessages.appendChild(botMessage);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          if (data.path_adjusted) {
            updateLearningPath();
          }
        } else {
          alert(data.error || "AI 沒有回應");
        }
      })
      .catch((error) => {
        loadingOverlay.style.display = "none";
        alert("AI 回應失敗");
        console.error("錯誤：", error); 
      });
  }
}


    sendMessageBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    // Handle path confirmation
    confirmPathBtn.addEventListener("click", function () {
      loadingOverlay.style.display = "flex";
      fetch("/api/confirm-learning-path", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          loadingOverlay.style.display = "none"
          if (data.success) {
            window.location.href = data.redirect || "/learning";
          } else {
            alert(data.error || "確認學習路徑失敗");
          }
        })
        .catch((error) => {
          loadingOverlay.style.display = "none"
          alert("請求失敗");
          console.error("錯誤：", error);
        });
    });
  });
</script>

<script>
 const confirmPathBtn = document.getElementById("confirm-path");
const loadingOverlay = document.getElementById("loading-overlay");

confirmPathBtn.addEventListener("click", function () {
  // 顯示 loading
  loadingOverlay.style.display = "flex";

  fetch("/api/confirm-learning-path", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
  })
    .then((response) => response.json())
    .then((data) => {
      loadingOverlay.style.display = "none"; // 請求完成，隱藏 loading
      if (data.success) {
        window.location.href = data.redirect || "/learning";
      } else {
        alert(data.error || "確認學習路徑失敗");
      }
    })
    .catch((error) => {
      loadingOverlay.style.display = "none"; // 請求失敗，也隱藏
      alert("請求失敗");
      console.error("錯誤：", error);
    });
});

</script>


<style>
  .message {
    padding: 10px 15px;
    margin-bottom: 10px;
    border-radius: 10px;
    max-width: 80%;
  }

  .bot-message {
    background-color: #f0f0f0;
    margin-right: auto;
  }

  .user-message {
    background-color: #007bff;
    color: white;
    margin-left: auto;
  }

  .chat-container {
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/tengbao/vanta@latest/dist/vanta.clouds.min.js"></script>
<script>
  VANTA.CLOUDS({
    el: "#vanta-bg",
    mouseControls: true,
    touchControls: true,
    gyroControls: false,
    minHeight: 200.00,
    minWidth: 200.00,
    backgroundColor: 0xffffff,
    skyColor: 0x0babea,
    cloudColor: 0xadc1de,
    cloudShadowColor: 0x486a95,
    sunColor: 0xf189ff,
    sunGlareColor: 0xe36262,
    sunlightColor: 0xff7c00,
    speed: 1.0
  });
</script>

{% endblock %}


